
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   
    
    <link rel="apple-touch-icon" href="icon.png">
    <title>Conveyor Calculator</title>
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <!-- Shortcut Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .popup-content {
    background-image: url('back2.jpg');
    background-size: cover;
    background-repeat: no-repeat; 
    background-position: bottom right;  /* Adjust this line */
    max-height: 400px; /* You can adjust this value as per your requirement */
    overflow-y: auto;
}

.lap-time {
    background-color: rgba(0, 0, 0, 0.242); 
}

.popup-item {
    font-size: 20px;
    padding: 8px; /* Adjust the padding size as needed */
}
#deleteLapPopup button {
    font-size: 17px;  /* Adjust as per your need */
    padding: 7px 12px; /* Vertical and horizontal padding */
    cursor: pointer; /* To change cursor to hand when hovering */
    border: 1px solid black;
    border-radius: 5px;
}


        body {
            background-color: black;
        }
        body {
            background-image: url('background.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-weight: bold;
        }
         .bold { font-weight: bold; }
        .input-small { width: 6rem; }
        .red { color: red; }
        .green { color: green; }
        .blue { color: rgb(7, 7, 94); }
         .purple { color: purple; }
        .orange { color: orange; }
        .content {
            background-color: rgba(209, 209, 209, 0.7);
            padding: 20px;
            border-radius: 0px;
        }
        
        
.lap-time {
    background-color: rgba(0, 0, 0, 0.242); 
}
/* Add padding to the pop-up items */
.popup-item {
    font-size: 20px;
    padding: 10px; /* Adjust the padding size as needed */
}
        #recordLap1, #recordLap2 {
            width: auto;
            height: auto;
            font-size: 230%;
        }
    

        /* Increase the size of Conveyor headers by 50% */
        .conveyor-header {
        font-size: 180%;
        }

/* Style for the pop-up window */
.popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.242); /* Darker background for better readability */
        z-index: 2000; /* Ensure it stays above the QR code */
        color: rgb(0, 0, 0); /* White text color for better readability */
        font-size: 1.2em; /* Slightly larger font size for better readability */
    }

button {
    color: rgb(0, 0, 0);
    background-color: white;
}
#blackoutScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 9999; /* Ensure it covers everything */
        }
#countdownDisplay {
        position: fixed;   /* Ensure it stays fixed in the viewport */
        bottom: 0;         /* Positions it at the bottom of the viewport */
        left: 33.33%;      /* Aligns it one third in from the left side */
        width: 33.33%;     /* Makes it span one third of the viewport width */
        color: rgb(0, 0, 0);      /* Black text color for visibility */
      
        padding: 10px 0;   /* Adds some vertical padding */
    }
   
    #conveyorCalculator {
   
    top: 0;                /* Positions it at the top of the viewport */
    left: 0;               /* Start from the very left edge of the viewport */
    width: 100%;           /* Makes it span the full width of the viewport */
    text-align: center;    /* Center-aligns the text */
   
    color: rgb(0, 0, 0);       /* White text color for visibility */
    padding: 10px 0;       /* Adds some vertical padding */
    box-sizing: border-box;/* Ensures that padding and border are included in the total width and height */
    z-index: 1000;         /* Ensures it stays above other elements */
}
#topClock {
            position: fixed;
            top: 0;
            left: 27%; /* 30% left of center */
            width: 37%;
            text-align: center;
            font-size: 2.3em;
            font-family: Arial, sans-serif; /* Set the font family */
            z-index: 1001; /* Ensure it stays above other elements */
        }
   /* ... existing code ... */
   .qr-code {
    position: fixed;
    bottom: 2px; /* Give 10px from the bottom of the screen */
    right: 2px;  /* Give 10px from the right side of the screen */
    transform: scale(0.7); /* Scale down to 20% of its original size */
    z-index: 1; /* Ensure it stays behind other elements */
    background-color: transparent; /* Set background to transparent */
    border-radius: 15px; /* Adjust the value to round the corners */
    padding: 20; /* Ensure no padding */
    
}

.popup-content {
    background-color: white;
    width: 80%;
    max-width: 400px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
    max-height: 90vh; /* Ensure the popup content fits within the viewport height */
    overflow-y: auto; /* Enable scrolling if content overflows */
}

/* Style for the close button */
#closeSettings {
    background-color: #ccc;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    float: right;
}

/* Add more styles as needed for your settings window */
    </style>
</head>
<body>
<div class="content">
    <button id="enableSoundButton" style="display: none;">Enable Sound</button>
    <h1 id="conveyorCalculator" style="font-size: 2.2rem; display: none;">Conveyor Calculator</h1>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button id="startConveyor2" style="display: none; border: 1px solid black; border-radius: 5px; width: 200px;margin-top: 10px;margin-right: 20px;">START CONVEYOR 2</button>
        <button id="startConveyor1" style="display: none; border: 1px solid black; border-radius: 5px; width: 200px;margin-top: 10px; margin-left: 20px;">START CONVEYOR 1</button>
    </div>
    <div style="display: flex; justify-content: center; margin-top: 20px;">
        <button id="recordLap2" style="display: none; border: 1px solid black; border-radius: 5px; width: 170px; margin-right: 5px; font-size: 20px;">Lap Conveyor 2</button>
        <button id="recordLap1" style="display: none; border: 1px solid black; border-radius: 5px; width: 170px; margin-left: 5px; font-size: 20px;">Lap Conveyor 1</button>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; margin-top: 20px;">
        <div style="display: flex; justify-content: start; width: 100%; margin-bottom: 0;">
            <button id="openSettings" style="display: none; border: 1px solid black; border-radius: 5px; margin-right: auto; margin-top: 10px; position: absolute; top: 0; left: 0;" onclick="document.getElementById('settingsPopup').style.display='block'">Settings</button>
<button id="pullLaps" style="display: none; border: 1px solid black; border-radius: 5px; margin-left: auto; margin-top: 10px; position: absolute; top: 0; right: 0;">Pull Laps</button>
        </div>              
    </div>
    <button id="playSoundButton" style="display: none;" onclick="playSound()">Play Sound</button>
    <div id="settingsPopup" class="popup" style="display: none;">
        <div class="popup-content">
            <!-- ... existing code ... -->
            <div style="border-top: 2px solid black; margin: 10px 0;"></div> <!-- Black line between sections -->
            <!-- New checkbox for blackout screen -->
            <div class="black" style="margin-top: 20px; font-size: 1.1em;">
                <label for="blackoutCheckbox">Blackout Screen:</label>
                <input type="checkbox" id="blackoutCheckbox">
            </div>
            <!-- Add content for the settings window here -->
            <button onclick="openDeleteLapPopup('conveyor2')" style="border: 1px solid black; border-radius: 5px;">Delete Lap Conveyor 2</button>
            <button onclick="openDeleteLapPopup('conveyor1')" style="border: 1px solid black; border-radius: 5px;">Delete Lap Conveyor 1</button>
            <div id="deleteLapPopup" class="popup">
                <div class="popup-content2">
                    <h2></h2>
                    <div id="lapList"></div>
                    <button onclick="closeDeleteLapPopup()" style="border: 1px solid black; border-radius: 5px;">Cancel</button>
                </div>
            </div>
            <div style="border-top: 2px solid black; margin: 10px 0;"></div> <!-- Black line between sections -->
            <div class="black" style="margin-top: 20px;">
                Subtract Cut Pull conveyor1 =
                <input type="number" id="subtractLoad1" class="input-small" style="border: 1px solid black; border-radius: 5px;" placeholder="Subtract Load 1">
            </div>
            <div class="black" style="margin-top: 10px;">
                Subtract Cut Pull conveyor2 =
                <input type="number" id="subtractLoad2" class="input-small" style="border: 1px solid black; border-radius: 5px;" placeholder="Subtract Load 2">
            </div>
            <!-- Set Time section hidden -->
            <div class="black" style="margin-top: 20px; display: none;">
                Set Time
                <input type="time" id="timeInput" class="input-small" style="border: 1px solid black;margin-top: 10px;color: black; background-color: white;border-radius: 5px; margin-right: 0px; padding: 0;" value="17:15">
            <button id="setTime" style="border: 1px solid black;border-radius: 5px; margin-left: 2px;margin-top: 10px; padding: 6;">Set</button>            
            </div>
            <div style="border-top: 2px solid black; margin: 10px 0;"></div> <!-- Black line between sections -->
            <!-- New div for setting conveyor units -->
            <div class="black" style="margin-top: 20px; font-size: 1.1em;">
                <div>Set Conveyor Units</div>
            </div>
            <div class="black" style="margin-top: 10px; font-size: 1.1em;">
                <label for="conveyor1Units">Conveyor 1 Units:</label>
                <select id="conveyor1Units" class="input-small" style="border: 1px solid black; border-radius: 5px; margin-top: 10px;">
                    <option value="9">9</option>
                    <option value="8">8</option>
                    <option value="10" selected>10</option>
                </select>
            </div>
            <div class="black" style="margin-top: 10px; font-size: 1.1em;">
                <label for="conveyor2Units">Conveyor 2 Units:</label>
                <select id="conveyor2Units" class="input-small" style="border: 1px solid black; border-radius: 5px; margin-top: 10px;">
                    <option value="10" selected>10</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
            <div style="border-top: 2px solid black; margin: 10px 0;"></div> <!-- Black line between sections -->
            <!-- New div for setting average laps -->
            <div class="black" style="margin-top: 20px; font-size: 1.1em;">
                <div>Set Average Laps</div>
            </div>
            <div class="black" style="margin-top: 10px;">
                <label for="conveyor1AvgLaps">Conveyor 1 Avg Laps:</label>
                <select id="conveyor1AvgLaps" class="input-small" style="border: 1px solid black; border-radius: 5px; margin-top: 10px;">
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="10" selected>10</option>
                </select>
            </div>
            <div class="black" style="margin-top: 10px;">
                <label for="conveyor2AvgLaps">Conveyor 2 Avg Laps:</label>
                <select id="conveyor2AvgLaps" class="input-small" style="border: 1px solid black; border-radius: 5px; margin-top: 10px;">
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="10" selected>10</option>
                </select>
            </div>
            <div style="border-top: 2px solid black; margin: 10px 0;"></div> <!-- Black line between sections -->
            <!-- New button to reset laps -->
            <div class="black" style="margin-top: 20px;">
                <button id="resetLaps" style="border: 1px solid black; border-radius: 5px;">Reset Laps</button>
            </div>
            <button id="closeSettings" style="border: 1px solid black; border-radius: 10px; background-color: white; color: black; padding: 10px 20px; font-size: 16px; margin-top: 20px;" onclick="document.getElementById('settingsPopup').style.display='none'">Done</button>
        </div>
   

    </div>
</div>
<div id="stats" class="content" style="display: flex;padding:30px; justify-content: space-between; width: 120%; height: 100%;">
    <!-- Display statistics here -->
    <div id="conveyor2Stats" style="width: 50%; height: 100%; font-size: 1.5em;"></div>
    <div id="conveyor1Stats" style="width: 50%; height: 100%; font-size: 1.5em;"></div>
    <div id="blackoutScreen"></div>
    <img src="qr-code.png" alt="QR Code" class="qr-code">
    
    <div id="topClock"style="padding: 15px;></div>
</div>

<div id="clock" class="countdown-timer" style="position: fixed; bottom: 0; left: 33.33%; width: 33.33%; font-size: 2em; text-align: center;"></div>


    <script src="https://www.gstatic.com/firebasejs/9.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.5.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdX_RAPVeG-uekG-lG1nhSFzZkTMRgg0c",
            authDomain: "conveyor-laps.firebaseapp.com",
            databaseURL: "https://conveyor-laps-default-rtdb.firebaseio.com",
            projectId: "conveyor-laps",
            storageBucket: "conveyor-laps.appspot.com",
            messagingSenderId: "708197721355",
            appId: "1:708197721355:web:234d1d9223b125a657ee0e",
            measurementId: "G-X2REH4L1M5"
        };

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
let database = firebase.database();

let isOnline = true; // Track online/offline status
        let pendingDataToSend = []; // Array to store data when offline
        const localLapList = [/* array of laps */];  // Example local lap list

// Reinitialize Firebase and send any pending data 2 seconds after screen focus
window.addEventListener('focus', () => {
    setTimeout(() => {
        reinitializeFirebase();
    }, 2500); // 2.5 seconds
});

function sendDataToFirebase(data, callback) {
    if (isOnline) {
        database.ref('your_data_path').push(data, (error) => {
            if (error) {
                // Data transmission failed, store it for future attempts
                pendingDataToSend.push(data);
            } else {
                console.log('Data sent to Firebase.');
                if (callback) callback(); // Invoke the callback upon successful transmission
            }
        });
    } else {
        // Device is offline, store the data for future attempts
        pendingDataToSend.push(data);
    }
}

function checkLapsAndSendMissing() {
    // Fetch data from Firebase
    database.ref('your_data_path').once('value').then(snapshot => {
        const firebaseLapList = snapshot.val() || [];

        // Compare the fetched data with the local lap list
        const missingLaps = localLapList.filter(lap => !firebaseLapList.includes(lap));

        // Send missing laps to Firebase
        for (const missingLap of missingLaps) {
            sendDataToFirebase(missingLap, () => {
                console.log('Missing lap sent to Firebase:', missingLap);
            });
        }
    }).catch(error => {
        console.error('Error fetching data from Firebase:', error);
    });
}

function reinitializeFirebase() {
    firebase.app().delete().then(() => {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log("Firebase reinitialized!");

        // Check if there is pending data to send, and if so, trigger data transmission
        if (pendingDataToSend.length > 0) {
            console.log('Sending pending data...');
            for (const data of pendingDataToSend) {
                sendDataToFirebase(data);
            }
            pendingDataToSend = []; // Clear the pending data array
        }

        // Check laps and send missing ones
        checkLapsAndSendMissing();
    }).catch((error) => {
        console.error("Error reinitializing Firebase:", error);
    });
}

// Listen for online/offline events
window.addEventListener('online', () => {
    isOnline = true;
    console.log('Device is online.');
});

window.addEventListener('offline', () => {
    isOnline = false;
    console.log('Device is offline.');
});

// Call sendDataToFirebase when you want to send data
const dataToSend = { /* your data object */ };
sendDataToFirebase(dataToSend);

        
        let lapStart1 = 0;
        let lapStart2 = 0;
        let running1 = false;
        let running2 = false;
        const lapTimes1 = [];
        const lapTimes2 = [];
        let timeDifference = 0;
        let timeDifferenceRemaining = 0;
        let workToBeDone1 = 0;
        let workToBeDone2 = 0;
        let targetTime = 0;
        let countdownInterval;
        let loadValue1 = 0;
        let loadValue2 = 0;
        let conveyor1Units = 10; // Default value for Conveyor 1 units
        let conveyor2Units = 10; // Default value for Conveyor 2 units
        let conveyor1AvgLaps = 4; // Default value for Conveyor 1 average laps
        let conveyor2AvgLaps = 4; // Default value for Conveyor 2 average laps

        function openDeleteLapPopup(conveyor) {
    const lapListDiv = document.getElementById('lapList');
    lapListDiv.innerHTML = ''; // Clear previous lap list

    // Get the lap times for the selected conveyor
    const lapTimes = conveyor === 'conveyor1' ? lapTimes1 : lapTimes2;

    // Convert date and time strings to timestamps and create an array of lap objects
    const lapObjects = lapTimes.map((lapData, index) => {
        const timestamp = lapData.timeOfDay ? Date.parse(lapData.timeOfDay.replace(/\//g, '/') + ':00') : 0;
        return { index, timestamp, lapData };
    });

    // Sort lap objects by timestamp in ascending order
    lapObjects.sort((a, b) => a.timestamp - b.timestamp);

    // Reverse the order to have the newest lap at the top
    lapObjects.reverse();

    // Display the list of laps with delete buttons
    lapObjects.forEach((lapObj) => {
        const lapData = lapObj.lapData;
        const lapTimeStr = new Date(lapData.lapTime).toISOString().substr(11, 8); // Convert milliseconds to HH:MM:SS
        lapListDiv.innerHTML += `
            <div>
                <button onclick="deleteSelectedLap('${conveyor}', ${lapObj.index})">
                    Delete Lap (${lapData.timeOfDay}) - ${lapTimeStr}
                </button>
            </div>
        `;
    });

    // Show the lap selection pop-up
    const deleteLapPopup = document.getElementById('deleteLapPopup');
    deleteLapPopup.style.display = 'block';
}
    // Function to close the lap selection pop-up
    function closeDeleteLapPopup() {
        const deleteLapPopup = document.getElementById('deleteLapPopup');
        deleteLapPopup.style.display = 'none';
    }

    // Function to delete a selected lap for a specific conveyor
    function deleteSelectedLap(conveyor, index) {
        const lapTimes = conveyor === 'conveyor1' ? lapTimes1 : lapTimes2;

        if (index >= 0 && index < lapTimes.length) {
            lapTimes.splice(index, 1); // Remove the selected lap
            displayStats(); // Update statistics
        }

        closeDeleteLapPopup(); // Close the lap selection pop-up
    }

    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secondsStr = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondsStr.toString().padStart(2, '0')}`;
    }

     // Function to subtract load value from Conveyor 1
document.getElementById('subtractLoad1').addEventListener('input', () => {
    const subtractLoad1 = parseInt(document.getElementById('subtractLoad1').value);
    if (!isNaN(subtractLoad1)) {
        // Subtract the entered value from the initial loadValue1
        loadValue1 = 0 - subtractLoad1;
        displayStats();
    } else {
        // If the input box is empty or contains non-numeric characters, reset the load value to 0
        loadValue1 = 0;
        displayStats();
    }
});

document.getElementById('subtractLoad2').addEventListener('input', () => {
    const subtractLoad2 = parseInt(document.getElementById('subtractLoad2').value);
    if (!isNaN(subtractLoad2)) {
        // Subtract the entered value from the initial loadValue2
        loadValue2 = 0 - subtractLoad2;
        displayStats();
    } else {
        // If the input box is empty or contains non-numeric characters, reset the load value to 0
        loadValue2 = 0;
        displayStats();
    }
});
function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const formattedTime = `${hours}:${minutes}:${ampm}`;
            document.getElementById('topClock').textContent = formattedTime;
        }

        setInterval(updateClock, 1000); // Update the clock every second
        updateClock(); // Initial call to display the clock immediately
        
        function calculateWorkToBeDone(averageTime, timeDifference) {
            return (averageTime > 0 ? timeDifference / averageTime : 0) - loadValue1 - loadValue2;
        }
        function displayStats() {
        const conveyor1StatsDiv = document.getElementById('conveyor1Stats');
        const conveyor2StatsDiv = document.getElementById('conveyor2Stats');
        conveyor1StatsDiv.innerHTML = '';
        conveyor2StatsDiv.innerHTML = '';

    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secondsStr = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondsStr.toString().padStart(2, '0')}`;
    }
    const averageTime2 = calculateAverageTimeX(lapTimes2, conveyor2AvgLaps);
        if (lapTimes2.length > 0) {
            const estNextTime2 = getEstimatedNextTimeWeighted(lapTimes2);
            const estNextTimeStr2 = estNextTime2.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
            conveyor2StatsDiv.innerHTML += `<div class="black conveyor-header" style="font-family: Arial, sans-serif; font-size: 1.8em; position: absolute; top: 55px;">Conveyor 2 <span style="float: right;font-size: 0.5em; position: relative; left: 5px; top: 16px;">Est Next: ${estNextTimeStr2}</span></div>`;
        } else {
            conveyor2StatsDiv.innerHTML += `<div class="black conveyor-header" style="font-family: Arial, sans-serif; font-size: 1.8em; position: absolute; top: 55px;">Conveyor 2</div>`;
        }
conveyor2StatsDiv.innerHTML += `<div style="font-size: 0.8em;">
    ${conveyor2Units !== 10 ? 
        `(<span style="color: red;">${conveyor2Units} units</span>, 
        <span style="color: black; font-weight: bold;">${conveyor2AvgLaps} avg laps</span>)` : 
        `(<span style="color: black;">${conveyor2Units} units</span>, 
        <span style="color: black; font-weight: bold;">${conveyor2AvgLaps} avg laps</span>)`}
</div>`;
conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
conveyor2StatsDiv.innerHTML += `<div class="green" style="font-family: Arial, sans-serif; font-size: 1em;">Average Lap Time: ${formatTime(averageTime2)}</div>`;
conveyor2StatsDiv.innerHTML += `<div class="black" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Average Last 4 Laps: ${formatTime(calculateAverageTimeX(lapTimes2, 4))}</div>`;
conveyor2StatsDiv.innerHTML += `<div class="green" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Average Last 2 Laps: ${formatTime(calculateAverageTimeX(lapTimes2, 2))}</div>`;

if (running2) {
    const runningTime2 = Math.floor((Date.now() - lapStart2) / 1000);
    
    // Calculate time since newest lap
    const newestLapTime2 = lapTimes2[lapTimes2.length - 1].timeOfDay; // Access the correct property
    const timeSinceNewestLap2 = Date.now() - parseDate(newestLapTime2); // Use parseDate function
    if (!isNaN(timeSinceNewestLap2)) {
        conveyor2StatsDiv.innerHTML += `<div class="black bold" style="font-family: Arial, sans-serif; font-size: 1em;">Current lap time: ${new Date(timeSinceNewestLap2).toISOString().substr(11, 8)} </div>`;
    } else {
        console.error('Invalid time value for newest lap time:', newestLapTime2);
    }
}

conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.1;">&nbsp;</div>';
conveyor2StatsDiv.innerHTML += '<div class="blue" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Lap times:</div>';
conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
lapTimes2.slice().reverse().forEach((lapData, idx) => {
    const lapTimeStr = formatTime(Math.floor(lapData.lapTime / 1000)); // Convert milliseconds to HH:MM:SS
    const [date, time] = lapData.timeOfDay.split(' ');
    const lapDuration = parseTime(lapTimeStr);
    const averageLapDuration = calculateAverageTime(lapTimes2);
    const lapColor = lapDuration > 2 * averageLapDuration ? 'red' : 'blue';
    const isAveraged = idx < conveyor2AvgLaps;
    conveyor2StatsDiv.innerHTML += `<div class="${lapColor}" style="font-family: Arial, sans-serif; font-size: 1em; font-weight: ${isAveraged ? 'bold' : 'normal'};">${lapTimes2.length - idx}.(${lapData.timeOfDay}) - ${lapTimeStr} </div>`;
});

conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';

   // Display load lift information at all times
const averageTimeAll2 = calculateAverageTime(lapTimes2);
const averageTimeX2_2 = calculateAverageTimeX(lapTimes2, 2);
const averageTimeX4_2 = calculateAverageTimeX(lapTimes2, 4);

// 12-hour period (43200 seconds)
const twelveHours = 43200;

const workToBeDone2_All = calculateWorkToBeDone(averageTimeAll2, timeDifferenceRemaining);
const workToBeDone2_X2 = calculateWorkToBeDone(averageTimeX2_2, timeDifferenceRemaining);
const workToBeDone2_X2_12h = calculateWorkToBeDone(averageTimeAll2, twelveHours); // Changed to use averageTimeAll2
const workToBeDone2_X4 = calculateWorkToBeDone(averageTimeX4_2, timeDifferenceRemaining);

conveyor2StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 1.18em;">Full Shift Load = ${(twelveHours / averageTime2).toFixed(1)} <span style="margin-left: 40px;">Lifts = ${((twelveHours / averageTime2) * conveyor2Units / 16).toFixed(1)}</span></div>`;
conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
conveyor2StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 1.18em;">Shift End Load = ${(timeDifferenceRemaining / averageTime2).toFixed(1)} <span style="margin-left: 40px;">Lifts = ${((timeDifferenceRemaining / averageTime2) * conveyor2Units / 16).toFixed(1)}</span></div>`;
conveyor2StatsDiv.innerHTML += `<div class="black" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Avg 4x - Load Conveyor 2 = ${(workToBeDone2_X4 + loadValue2).toFixed(1)}  (Lifts = ${((workToBeDone2_X4 + loadValue2) * 10 / 16).toFixed(1)})</div>`;
conveyor2StatsDiv.innerHTML += `<div class="green" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Avg 2x - Load Conveyor 2 = ${(workToBeDone2_X2 + loadValue2).toFixed(1)}  (Lifts = ${((workToBeDone2_X2 + loadValue2) * 10 / 16).toFixed(1)})</div>`;

conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';

conveyor2StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
const averageTime1 = calculateAverageTimeX(lapTimes1, conveyor1AvgLaps);
        if (lapTimes1.length > 0) {
            const estNextTime1 = getEstimatedNextTimeWeighted(lapTimes1);
            const estNextTimeStr1 = estNextTime1.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
            conveyor1StatsDiv.innerHTML += `<div class="black conveyor-header" style="font-family: Arial, sans-serif; font-size: 1.8em; position: absolute; top: 55px;">Conveyor 1 <span style="float: right;font-size: 0.5em; position: relative; left: 5px; top: 16px;">Est Next: ${estNextTimeStr1}</span></div>`;
        } else {
            conveyor1StatsDiv.innerHTML += `<div class="black conveyor-header" style="font-family: Arial, sans-serif; font-size: 1.8em; position: absolute; top: 55px;">Conveyor 1</div>`;
        }
conveyor1StatsDiv.innerHTML += `<div style="font-size: 0.8em;">
    ${conveyor1Units !== 10 ? 
        `(<span style="color: red;">${conveyor1Units} units</span>, 
        <span style="color: black; font-weight: bold;">${conveyor1AvgLaps} avg laps</span>)` : 
        `(<span style="color: black;">${conveyor1Units} units</span>, 
        <span style="color: black; font-weight: bold;">${conveyor1AvgLaps} avg laps</span>)`}
</div>`;
conveyor1StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
conveyor1StatsDiv.innerHTML += `<div class="green" style="font-family: Arial, sans-serif; font-size: 1em;">Average Lap Time : ${formatTime(averageTime1)}</div>`;

conveyor1StatsDiv.innerHTML += `<div class="black" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Average Last 4 Laps: ${formatTime(calculateAverageTimeX(lapTimes1, 4))}</div>`;
conveyor1StatsDiv.innerHTML += `<div class="green" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Average Last 2 Laps: ${formatTime(calculateAverageTimeX(lapTimes1, 2))}</div>`;

if (running1) {
    const runningTime1 = Math.floor((Date.now() - lapStart1) / 1000);
    
    // Calculate time since newest lap
    const newestLapTime1 = lapTimes1[lapTimes1.length - 1].timeOfDay; // Access the correct property
    const timeSinceNewestLap1 = Date.now() - parseDate(newestLapTime1); // Use parseDate function
    if (!isNaN(timeSinceNewestLap1)) {
        conveyor1StatsDiv.innerHTML += `<div class="black bold" style="font-family: Arial, sans-serif; font-size: 1em;">Current lap time: ${new Date(timeSinceNewestLap1).toISOString().substr(11, 8)} </div>`;
    } else {
        console.error('Invalid time value for newest lap time:', newestLapTime1);
    }
}

conveyor1StatsDiv.innerHTML += '<div style="line-height: 0.1;">&nbsp;</div>';
conveyor1StatsDiv.innerHTML += '<div class="blue" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Lap times:</div>';
conveyor1StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
lapTimes1.slice().reverse().forEach((lapData, idx) => {
    const lapTimeStr = formatTime(Math.floor(lapData.lapTime / 1000)); // Convert milliseconds to HH:MM:SS
    const [date, time] = lapData.timeOfDay.split(' ');
    const lapDuration = parseTime(lapTimeStr);
    const averageLapDuration = calculateAverageTime(lapTimes1);
    const lapColor = lapDuration > 2 * averageLapDuration ? 'red' : 'blue';
    const isAveraged = idx < conveyor1AvgLaps;
    conveyor1StatsDiv.innerHTML += `<div class="${lapColor}" style="font-family: Arial, sans-serif; font-size: 1em; font-weight: ${isAveraged ? 'bold' : 'normal'};">${lapTimes1.length - idx}.(${lapData.timeOfDay}) - ${lapTimeStr} </div>`;
});

conveyor1StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';

// Display load lift information at all times for Conveyor 1
const averageTimeAll1 = calculateAverageTime(lapTimes1);
const averageTimeX2_1 = calculateAverageTimeX(lapTimes1, 2);
const averageTimeX4_1 = calculateAverageTimeX(lapTimes1, 4);

const workToBeDone1_All = calculateWorkToBeDone(averageTimeAll1, timeDifferenceRemaining);
const workToBeDone1_X2 = calculateWorkToBeDone(averageTimeX2_1, timeDifferenceRemaining);
const workToBeDone1_X2_12h = calculateWorkToBeDone(averageTimeAll1, twelveHours); // Changed to use averageTimeAll1
const workToBeDone1_X4 = calculateWorkToBeDone(averageTimeX4_1, timeDifferenceRemaining);

conveyor1StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 1.18em;">Full Shift Load = ${(twelveHours / averageTime1).toFixed(1)} <span style="margin-left: 40px;">Lifts = ${((twelveHours / averageTime1) * conveyor1Units / 16).toFixed(1)}</span></div>`;
conveyor1StatsDiv.innerHTML += '<div style="line-height: 0.5;">&nbsp;</div>';
conveyor1StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 1.18em;">Shift End Load = ${(timeDifferenceRemaining / averageTime1).toFixed(1)} <span style="margin-left: 40px;">Lifts = ${((timeDifferenceRemaining / averageTime1) * conveyor1Units / 16).toFixed(1)}</span></div>`;
conveyor1StatsDiv.innerHTML += '<div style="line-height: 1;">&nbsp;</div>';
// New calculations for 24hr 3 Man Day and 24hr 3 Man Night
const fullShiftLifts1 = (twelveHours / averageTime1) * conveyor1Units / 16;
const fullShiftLifts2 = (twelveHours / averageTime2) * conveyor2Units / 16;
const combinedFullShiftLifts = (fullShiftLifts1 + fullShiftLifts2) * 2 / 3;
const oneThirdCombinedLifts = combinedFullShiftLifts;
const conveyor1_24hr3ManNight = oneThirdCombinedLifts;
const conveyor2_24hr3ManNight = oneThirdCombinedLifts;
const conveyor1_24hr3ManDay = conveyor1_24hr3ManNight - fullShiftLifts1;
const conveyor2_24hr3ManDay = conveyor2_24hr3ManNight - fullShiftLifts2;

const finalConveyor1_24hr3ManDay = conveyor1_24hr3ManDay < 0 ? fullShiftLifts1 + Math.abs(conveyor1_24hr3ManDay) : fullShiftLifts1 - conveyor1_24hr3ManDay;
const finalConveyor2_24hr3ManDay = conveyor2_24hr3ManDay < 0 ? fullShiftLifts2 + Math.abs(conveyor2_24hr3ManDay) : fullShiftLifts2 - conveyor2_24hr3ManDay;

const overflow1 = finalConveyor1_24hr3ManDay < 0 ? Math.abs(finalConveyor1_24hr3ManDay) : 0;
const overflow2 = finalConveyor2_24hr3ManDay < 0 ? Math.abs(finalConveyor2_24hr3ManDay) : 0;

const adjustedConveyor1_24hr3ManNight = conveyor1_24hr3ManNight - overflow1;
const adjustedConveyor2_24hr3ManNight = conveyor2_24hr3ManNight - overflow2;

const adjustedConveyor1_24hr3ManDay = overflow2 > 0 ? finalConveyor1_24hr3ManDay - overflow2 : finalConveyor1_24hr3ManDay;
const adjustedConveyor2_24hr3ManDay = overflow1 > 0 ? finalConveyor2_24hr3ManDay - overflow1 : finalConveyor2_24hr3ManDay;

conveyor1StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 0.7em; position: fixed; bottom: 30px;">2 Man Day Lifts = ${adjustedConveyor1_24hr3ManNight.toFixed(1)}${overflow1 > 0 ? ` <span class="red">(cut other = ${overflow1.toFixed(1)})</span>` : ''}</div>`;
conveyor1StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 0.7em; position: fixed; bottom: 10px;">1 Man Night Lifts = ${overflow1 > 0 ? '0.0' : adjustedConveyor1_24hr3ManDay.toFixed(1)}</div>`;

conveyor2StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 0.7em; position: fixed; bottom: 30px;">2 Man Day Lifts = ${adjustedConveyor2_24hr3ManNight.toFixed(1)}${overflow2 > 0 ? ` <span class="red">(cut other = ${overflow2.toFixed(1)})</span>` : ''}</div>`;
conveyor2StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 0.7em; position: fixed; bottom: 10px;">1 Man Night Lifts = ${overflow2 > 0 ? '0.0' : adjustedConveyor2_24hr3ManDay.toFixed(1)}</div>`;
// conveyor1StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 1.18em;">Overflow = ${overflow1.toFixed(1)}</div>`;
// conveyor2StatsDiv.innerHTML += `<div class="black" style="font-family: Arial, sans-serif; font-size: 1.18em;">Overflow = ${overflow2.toFixed(1)}</div>`;
conveyor1StatsDiv.innerHTML += `<div class="black" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Avg 4x - Load Conveyor 1 = ${(workToBeDone1_X4 + loadValue1).toFixed(1)}  (Lifts = ${((workToBeDone1_X4 + loadValue1) * 10 / 16).toFixed(1)})</div>`;
conveyor1StatsDiv.innerHTML += `<div class="green" style="display: none; font-family: Arial, sans-serif; font-size: 1em;">Avg 2x - Load Conveyor 1 = ${(workToBeDone1_X2 + loadValue1).toFixed(1)}  (Lifts = ${((workToBeDone1_X2 + loadValue1) * 10 / 16).toFixed(1)})</div>`;
conveyor1StatsDiv.innerHTML += '<div style="line-height: 1;">&nbsp;</div>';

// Check if screen flash is on
database.ref('settings/TimeToShiftEnd').once('value').then(snapshot => {
            const flashValue = snapshot.val();
            if (flashValue === 1 && timeDifferenceRemaining > 0) {
                conveyor1StatsDiv.innerHTML += `<div id="countdownDisplay" class="red bold" style="font-family: Arial, sans-serif; font-size: 1em; position: fixed; bottom: 0; left: 30%; width: 28.33%; text-align: center;">Time to Shift Change: ${formatTime(timeDifferenceRemaining % 43200)}</div>`;
            }
        });

}
function startCountdown() {
            clearInterval(countdownInterval);
            countdownInterval = setInterval(function() {
                if (timeDifferenceRemaining > 0) {
                    timeDifferenceRemaining--;

                    displayStats();
                } else {
                    // Reset the timer to 12 hours at 5:15
                    const now = new Date();
                    const resetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 5, 15);
                    if (now >= resetTime) {

                        resetTime.setDate(resetTime.getDate() + 1);

                    }
                    timeDifferenceRemaining = (resetTime.getTime() - now.getTime()) / 1000;
                    displayStats();
                }
            }, 1000);
        }
        const blackoutCheckbox = document.getElementById('blackoutCheckbox');
        const blackoutScreen = document.getElementById('blackoutScreen');

        // Function to update blackout screen based on Firebase value
        function updateBlackoutScreen(value) {
            if (value === 0) {
                blackoutScreen.style.display = 'block';
                blackoutCheckbox.checked = true;
            } else {
                blackoutScreen.style.display = 'none';
                blackoutCheckbox.checked = false;
            }
        }

        // Read the initial value from Firebase
        database.ref('settings/toggleSwitch').once('value').then(snapshot => {
            const value = snapshot.val();

            updateBlackoutScreen(value);
        });

        // Listen for changes in the Firebase value
        database.ref('settings/toggleSwitch').on('value', snapshot => {
            const value = snapshot.val();
            updateBlackoutScreen(value);
        });

        // Update Firebase when the checkbox is changed

        if (blackoutCheckbox) {
            blackoutCheckbox.addEventListener('change', (event) => {
                const value = event.target.checked ? 1 : 0;
                database.ref('settings/toggleSwitch').set(value);

            });
        }

        // Function to reset settings at 5:15 AM and PM
        function resetSettingsAt515() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            if (minutes === 15 && (hours === 5 || hours === 17)) {
                // Reset sound settings for con1 and con2 to 0
                database.ref('settings/sound/con1').set(0, (error) => {
                    if (error) {
                        console.error('Failed to reset con1 sound setting in Firebase:', error);
                    } else {
                        console.log('con1 sound setting reset to 0 in Firebase.');
                    }
                });

                database.ref('settings/sound/con2').set(0, (error) => {

                    if (error) {
                        console.error('Failed to reset con2 sound setting in Firebase:', error);
                    } else {
                        console.log('con2 sound setting reset to 0 in Firebase.');
                    }
                });

                // Change blackout screen to 1
                database.ref('settings/toggleSwitch').set(1, (error) => {
                    if (error) {

                        console.error('Failed to set toggleSwitch to 1 in Firebase:', error);
                    } else {
                        console.log('toggleSwitch set to 1 in Firebase.');
                    }
                });
            }
        }

        // Check every minute to reset settings at 5:15 AM and PM
        setInterval(resetSettingsAt515, 60000);
     
   
        let timerValue; // No default value, will be set from Firebase

// Listen for changes in the timer value in real-time
database.ref('settings/timer').on('value', (snapshot) => {
    timerValue = snapshot.val();
    console.log('Timer value updated:', timerValue);
});

// Function to play the sound
function playSound() {
    const audio = new Audio('sound1.mp3');
    audio.play().then(() => {
        console.log('Sound played successfully');
    }).catch(error => {
        console.error('Error playing sound:', error);
    });
}

// Function to trigger the sound by clicking the hidden button
function triggerSound(conveyor) {
    const playSoundButton = document.getElementById('playSoundButton');
    if (playSoundButton) {
        // Check Firebase setting before triggering sound
        database.ref(`settings/sound/${conveyor}`).once('value').then(snapshot => {
            if (snapshot.val() === 1) {
                playSoundButton.click();
            }
        });
    }
}

// Listen for changes in the sound setting for Conveyor 1
let soundPlayedCon1 = false; // Track if the sound has been played for Conveyor 1
database.ref('settings/sound/con1').on('value', (snapshot) => {
    const value = snapshot.val();
    if (value === 1 && !soundPlayedCon1) {
        triggerSound('con1');
        soundPlayedCon1 = true; // Mark that the sound has been played for Conveyor 1
    } else if (value === 0) {
        soundPlayedCon1 = false; // Reset the flag when the value changes to 0
    }
});

// Listen for changes in the sound setting for Conveyor 2
let soundPlayedCon2 = false; // Track if the sound has been played for Conveyor 2
database.ref('settings/sound/con2').on('value', (snapshot) => {
    const value = snapshot.val();
    if (value === 1 && !soundPlayedCon2) {
        triggerSound('con2');
        soundPlayedCon2 = true; // Mark that the sound has been played for Conveyor 2
    } else if (value === 0) {
        soundPlayedCon2 = false; // Reset the flag when the value changes to 0
    }
});

// Enable sound playback after user interaction
document.getElementById('enableSoundButton').addEventListener('click', () => {
    // Hide the enable sound button
    document.getElementById('enableSoundButton').style.display = 'none';

    // Now the user has interacted with the page, we can play sounds
    triggerSound('con1');
    triggerSound('con2');
});

// Function to update the countdown timer
function updateCountdownTimer() {
    if (timerValue === undefined) return; // Exit if timerValue is not set

    const now = new Date();
    const estNextTime1 = getEstimatedNextTimeWeighted(lapTimes1);
    const estNextTime2 = getEstimatedNextTimeWeighted(lapTimes2);

    if (estNextTime1) {
        const timeDifference1 = (estNextTime1 - now) / 1000; // in seconds
        if (timeDifference1 <= timerValue && timeDifference1 > 0 && !hasFlashed1) {
            triggerSound('con1');
            hasFlashed1 = true;
        } else if (timeDifference1 > timerValue) {
            hasFlashed1 = false; // Reset the flag if more than timer value
        }
        const countdownDisplay1 = document.getElementById('countdownDisplay1');
        if (countdownDisplay1) {
            countdownDisplay1.textContent = formatTime(timeDifference1);
        }
    }

    if (estNextTime2) {
        const timeDifference2 = (estNextTime2 - now) / 1000; // in seconds
        if (timeDifference2 <= timerValue && timeDifference2 > 0 && !hasFlashed2) {
            triggerSound('con2');
            hasFlashed2 = true;
        } else if (timeDifference2 > timerValue) {
            hasFlashed2 = false; // Reset the flag if more than timer value
        }
        const countdownDisplay2 = document.getElementById('countdownDisplay2');
        if (countdownDisplay2) {
            countdownDisplay2.textContent = formatTime(timeDifference2);
        }
    }
}

// Update the countdown timer every second
setInterval(updateCountdownTimer, 1000);

    // Function to calculate the estimated next time for a conveyor
    function getEstimatedNextTimeWeighted(lapTimes) {
        if (lapTimes.length === 0) return null;

        const averageTime = calculateWeightedAverageTime(lapTimes);
        const newestLapTime = parseDate(getNewestLapTime(lapTimes));
        return new Date(newestLapTime + averageTime * 1000);
    }

    // Function to update the countdown timer
    function updateCountdownTimer() {
        const now = new Date();
        const estNextTime1 = getEstimatedNextTimeWeighted(lapTimes1);
        const estNextTime2 = getEstimatedNextTimeWeighted(lapTimes2);

        if (estNextTime1) {
            const timeDifference1 = (estNextTime1 - now) / 1000; // in seconds
            if (timeDifference1 <= 600 && timeDifference1 > 0 && !hasFlashed1) { // 10 minutes in seconds
                triggerSound();
                hasFlashed1 = true;
            } else if (timeDifference1 > 600) {
                hasFlashed1 = false; // Reset the flag if more than 10 minutes
            }
            const countdownDisplay1 = document.getElementById('countdownDisplay1');
            if (countdownDisplay1) {
                countdownDisplay1.textContent = formatTime(timeDifference1);
            }
        }

        if (estNextTime2) {
            const timeDifference2 = (estNextTime2 - now) / 1000; // in seconds
            if (timeDifference2 <= 600 && timeDifference2 > 0 && !hasFlashed2) { // 10 minutes in seconds
                triggerSound();
                hasFlashed2 = true;
            } else if (timeDifference2 > 600) {
                hasFlashed2 = false; // Reset the flag if more than 10 minutes
            }
            const countdownDisplay2 = document.getElementById('countdownDisplay2');
            if (countdownDisplay2) {
                countdownDisplay2.textContent = formatTime(timeDifference2);
            }
        }
    }

    // Update the countdown timer every second
    setInterval(updateCountdownTimer, 1000);

    function calculateWorkToBeDone(averageTime, timeDifference) {
        return averageTime > 0 ? timeDifference / averageTime : 0;
    }

    // Function to format time in HH:MM:SS
    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secondsStr = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondsStr.toString().padStart(2, '0')}`;
    }

    // Function to parse a date string in the format day/month
    function parseDate(dateString) {
        const [datePart, timePart, ampm] = dateString.split(' ');
        const [day, month] = datePart.split('/').map(Number);
        const now = new Date();
        const year = now.getFullYear();
        const formattedDate = `${month}/${day}/${year} ${timePart} ${ampm}`;
        return Date.parse(formattedDate);
    }

    // Function to get the newest lap time
    function getNewestLapTime(lapTimes) {
        if (lapTimes.length > 0) {
            return lapTimes[lapTimes.length - 1].timeOfDay;
        }
        return null;
    }

    // Function to calculate the average time of the last X laps
    function calculateAverageTimeX(lapTimes, x) {
        const lastXLaps = lapTimes.slice(-x);
        const totalLapTime = lastXLaps.reduce((total, lapData) => total + lapData.lapTime, 0);
        return lastXLaps.length > 0 ? totalLapTime / lastXLaps.length / 1000 : 0;
    }

    function getFormattedTime() {
        const now = new Date();
        const day = now.getDate();
        const month = now.getMonth() + 1; // Months are 0-based, so add 1
        const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}`;
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const ampm = hours >= 12 ? 'pm' : 'am';
        const formattedTime = `${formattedDate} ${hours % 12}:${(minutes < 10 ? '0' : '') + minutes} ${ampm}`;
        return formattedTime;
    }

    function calculateAverageTime(lapTimes) {
        const totalLapTime = lapTimes.reduce((total, lapData) => total + lapData.lapTime, 0);
        const numLaps = lapTimes.length;
        return numLaps > 0 ? totalLapTime / numLaps / 1000 : 0;
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchSettingsFromFirebase();
        listenForSettingsChanges(); // Start listening for real-time changes

        // Add event listener for the enable lap buttons
        const enableLapButtons = document.getElementById('enableLapButtons');
        if (enableLapButtons) {
            enableLapButtons.addEventListener('click', () => {
                const password = document.getElementById('lapPassword').value;
                const correctPassword = 'W0rdpass'; // Replace with your actual password
                if (password === correctPassword) {
                    document.getElementById('recordLap1').disabled = false;
                    document.getElementById('recordLap2').disabled = false;
                    alert('Lap buttons enabled');
                } else {
                    alert('Incorrect password');
                }
            });
        }

        // Initially disable the lap buttons
        document.getElementById('recordLap1').disabled = true;
        document.getElementById('recordLap2').disabled = true;

        // Simulate a click on the "Pull Laps" button 2 seconds after page load
        setTimeout(simulatePullLapsButtonClick, 2000);
    });

    function calculateAverageTimeX2(lapTimes) {
        const lastTwoLaps = lapTimes.slice(-2);
        const totalLapTime = lastTwoLaps.reduce((total, lapData) => total + lapData.lapTime, 0);
        return lastTwoLaps.length > 0 ? totalLapTime / lastTwoLaps.length / 1000 : 0;
    }

    function calculateAverageTimeX4(lapTimes) {
        const lastFourLaps = lapTimes.slice(-4);
        const totalLapTime = lastFourLaps.reduce((total, lapData) => total + lapData.lapTime, 0);
        return lastFourLaps.length > 0 ? totalLapTime / lastFourLaps.length / 1000 : 0;
    }

    function calculateWeightedAverageTime(lapTimes) {
    if (lapTimes.length === 0) return 0;

    // Sort lap times in ascending order
    const sortedLapTimes = lapTimes.slice().sort((a, b) => a.lapTime - b.lapTime);

    // Weight the 2nd lap more heavily
    const weights = sortedLapTimes.map((lap, index) => (index === 1 ? 20 : 1)); // Weight of 20 for the 2nd lap, 1 for the rest

    // Calculate the weighted average
    const totalWeight = weights.reduce((total, weight) => total + weight, 0);
    const weightedLapTimeSum = sortedLapTimes.reduce((total, lap, index) => total + lap.lapTime * weights[index], 0);

    return weightedLapTimeSum / totalWeight / 1000; // Convert milliseconds to seconds
}

    // Example usage to calculate the estimated next time
    function getEstimatedNextTimeWeighted(lapTimes) {
        if (lapTimes.length === 0) return null;

        const averageTime = calculateWeightedAverageTime(lapTimes);
        const newestLapTime = parseDate(getNewestLapTime(lapTimes));
        return new Date(newestLapTime + averageTime * 1000);
    }

    // Function to simulate a click on the "Pull Laps" button
    function simulatePullLapsButtonClick() {
        const pullLapsButton = document.getElementById('pullLaps');
        if (pullLapsButton) {
            pullLapsButton.click();
        } else {
            console.error('Pull Laps button not found');
        }
    }

    // Function to get the newest lap time
    function getNewestLapTime(lapTimes) {
        if (lapTimes.length > 0) {
            return lapTimes[lapTimes.length - 1].timeOfDay;
        }
        return null;
    }

        document.getElementById('startConveyor1').addEventListener('click', () => {
    const button = document.getElementById('startConveyor1');
    if (!running1) {
        lapStart1 = Date.now();
        running1 = true;
        button.textContent = "STOP CONVEYOR 1"; // Change button text to "Stop Conveyor 1"
        startCountdown();
        displayStats();
    } else {
        // Ask for confirmation before stopping Conveyor 1
        const confirmStop = confirm("Are you sure you want to stop Conveyor 1?");
        if (confirmStop) {
            running1 = false;
            button.textContent = "START CONVEYOR 1"; // Change button text back to "Start Conveyor 1"
            // Calculate and update work to be done if needed
            if (timeDifferenceRemaining > 0) {
                workToBeDone1 = calculateWorkToBeDone(calculateAverageTime(lapTimes1), timeDifferenceRemaining);
                displayStats();
            }
        }
    }
});

// Update the event listener for Conveyor 2 in a similar manner
document.getElementById('startConveyor2').addEventListener('click', () => {
    const button = document.getElementById('startConveyor2');
    if (!running2) {
        lapStart2 = Date.now();
        running2 = true;
        button.textContent = "STOP CONVEYOR 2"; // Change button text to "Stop Conveyor 2"
        startCountdown();
        displayStats();
    } else {
        // Ask for confirmation before stopping Conveyor 2
        const confirmStop = confirm("Are you sure you want to stop Conveyor 2?");
        if (confirmStop) {
            running2 = false;
            button.textContent = "START CONVEYOR 2"; // Change button text back to "Start Conveyor 2"
            // Calculate and update work to be done if needed
            if (timeDifferenceRemaining > 0) {
                workToBeDone2 = calculateWorkToBeDone(calculateAverageTime(lapTimes2), timeDifferenceRemaining);
                displayStats();
            }
        }
    }
});

        function sendLapDataToFirebase(conveyor, lapTime, timeOfDay) {
            // Check if the lap time is greater than 15 minutes (900,000 milliseconds)
            if (parseTime(lapTime) > 900) {
                // Send lap time data to Firebase
                database.ref(`laps/${conveyor}`).push({
                    lapTime: lapTime,
                    timeOfDay: timeOfDay
                });
            }
        }
   // Function to update settings in Firebase
   function updateSettingsInFirebase(setting, value) {
            database.ref(`settings/${setting}`).set(value, (error) => {
                if (error) {
                    console.error(`Failed to update ${setting} in Firebase:`, error);
                } else {
                    console.log(`${setting} updated in Firebase.`);
                }
            });
        }

        // Function to fetch settings from Firebase on page load
        function fetchSettingsFromFirebase() {
            database.ref('settings').once('value').then((snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    if (settings.conveyor1Units !== undefined) {
                        conveyor1Units = settings.conveyor1Units;
                        document.getElementById('conveyor1Units').value = conveyor1Units;
                    }
                    if (settings.conveyor2Units !== undefined) {
                        conveyor2Units = settings.conveyor2Units;
                        document.getElementById('conveyor2Units').value = conveyor2Units;
                    }
                    if (settings.conveyor1AvgLaps !== undefined) {
                        conveyor1AvgLaps = settings.conveyor1AvgLaps;
                        document.getElementById('conveyor1AvgLaps').value = conveyor1AvgLaps;
                    }
                    if (settings.conveyor2AvgLaps !== undefined) {
                        conveyor2AvgLaps = settings.conveyor2AvgLaps;
                        document.getElementById('conveyor2AvgLaps').value = conveyor2AvgLaps;
                    }
                    if (settings.toggleSwitch !== undefined) {
                        const toggleSwitchElement = document.getElementById('toggleSwitch');
                        if (toggleSwitchElement) {
                            toggleSwitchElement.checked = settings.toggleSwitch;
                       
                        }
                    }
                    displayStats();
                }
            }).catch((error) => {
                console.error('Error fetching settings from Firebase:', error);
            });
        }

        // Function to listen for real-time changes in Firebase settings
        function listenForSettingsChanges() {
            database.ref('settings').on('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    if (settings.conveyor1Units !== undefined) {
                        conveyor1Units = settings.conveyor1Units;
                        document.getElementById('conveyor1Units').value = conveyor1Units;
                    }
                    if (settings.conveyor2Units !== undefined) {
                        conveyor2Units = settings.conveyor2Units;
                        document.getElementById('conveyor2Units').value = conveyor2Units;
                    }
                    if (settings.conveyor1AvgLaps !== undefined) {
                        conveyor1AvgLaps = settings.conveyor1AvgLaps;
                        document.getElementById('conveyor1AvgLaps').value = conveyor1AvgLaps;
                    }
                    if (settings.conveyor2AvgLaps !== undefined) {
                        conveyor2AvgLaps = settings.conveyor2AvgLaps;
                        document.getElementById('conveyor2AvgLaps').value = conveyor2AvgLaps;
                    }
                    displayStats();
                }
            });
        }

        document.getElementById('recordLap1').addEventListener('click', () => {
    if (running1) {
        const lapTime = formatTime(Math.floor((Date.now() - lapStart1) / 1000));
        const timeOfDay = getFormattedTime();
        lapTimes1.push({ lapTime, timeOfDay });
        if (lapTimes1.length > 10) {
            lapTimes1.shift(); // Remove the oldest lap if more than 10 laps
        }
        lapStart1 = Date.now();
        displayStats();

        // Send lap time data to Firebase
        sendLapDataToFirebase('conveyor1', lapTime, timeOfDay);
    }
});

document.getElementById('recordLap2').addEventListener('click', () => {
    if (running2) {
        const lapTime = formatTime(Math.floor((Date.now() - lapStart2) / 1000));
        const timeOfDay = getFormattedTime();
        lapTimes2.push({ lapTime, timeOfDay });
        if (lapTimes2.length > 10) {
            lapTimes2.shift(); // Remove the oldest lap if more than 10 laps
        }
        lapStart2 = Date.now();
        displayStats();

        // Send lap time data to Firebase
        sendLapDataToFirebase('conveyor2', lapTime, timeOfDay);
    }
});



document.getElementById('setTime').addEventListener('click', () => {
    const timeInput = document.getElementById('timeInput').value;
    const timeParts = timeInput.split(':');
    if (timeParts.length === 2) {
        const hours = parseInt(timeParts[0]);
        const minutes = parseInt(timeParts[1]);
        if (!isNaN(hours) && !isNaN(minutes)) {
            const now = new Date();
            targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
            if (targetTime <= now) {
                targetTime.setDate(targetTime.getDate() + 1);
            }
            timeDifference = targetTime.getTime() - now.getTime();
            timeDifferenceRemaining = timeDifference / 1000;
            // Check if it's after 5:15 PM and adjust timeDifferenceRemaining
            const fiveFifteenPM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 17, 15);
            if (now > fiveFifteenPM) {
                timeDifferenceRemaining -= 43200; // Subtract 12 hours (43200 seconds)
            }
            if (timeDifferenceRemaining > 43200) {
                timeDifferenceRemaining -= 43200; // Subtract 12 hours if over 12 hours
            }
            workToBeDone1 = calculateWorkToBeDone(calculateAverageTime(lapTimes1), timeDifferenceRemaining);
            workToBeDone2 = calculateWorkToBeDone(calculateAverageTime(lapTimes2), timeDifferenceRemaining);
            displayStats();
            startCountdown();
        }
    }
});

document.getElementById('pullLaps').addEventListener('click', () => {
    // Retrieve 8 laps from Firebase for Conveyor 1
    pullAndDisplay('conveyor1', lapTimes1, 10);
    // Retrieve 8 laps from Firebase for Conveyor 2
    pullAndDisplay('conveyor2', lapTimes2, 10);

    // Wait 10 seconds before resetting Irregulars to 0 in Firebase
    setTimeout(() => {
        database.ref('settings/Irregulars').set(0, (error) => {
            if (error) {
                console.error('Failed to reset Irregulars in Firebase:', error);
            } else {
                console.log('Irregulars reset to 0 in Firebase after 10 seconds.');
            }
        });
    }, 10000); // 10000 milliseconds = 10 seconds
});

  // Function to simulate a click on the "Pull Laps" button
  function simulatePullLapsButtonClick() {
        const pullLapsButton = document.getElementById('pullLaps');
        if (pullLapsButton) {
            pullLapsButton.click();
        } else {
            console.error('Pull Laps button not found');
        }
    }

    // Listen for changes in the Irregulars value
    database.ref('settings/Irregulars').on('value', (snapshot) => {
        const value = snapshot.val();
        if (value === 1) {
            simulatePullLapsButtonClick();
        }
    });

// Function to simulate a click on the "Set Time" button
function simulateSetTimeButtonClick() {
    const setTimeButton = document.getElementById('setTime');
    setTimeButton.click();
}
// Automatically click the "Set Time" button every 1 second
setInterval(simulateSetTimeButtonClick, 1000);

// New function to ping Firebase
function pingFirebase() {
    const ref = database.ref('.info/connected');
    ref.on('value', (snap) => {
        if (snap.val() === true) {
            console.log('Connected to Firebase');
        } else {
            console.log('Disconnected from Firebase');
        }
    });
}
// Ping Firebase every 2.5 minutes (250,000 milliseconds)
setInterval(pingFirebase, 250000);

function confirmDeleteLap(conveyor, index) {
    // Show a confirmation dialog
    const confirmation = window.confirm(` ${index + 1}  ${conveyor === 'conveyor1 ' ? '1' : '2'} `);
    if (confirmation) {
        deleteLap(conveyor, index);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Setup listeners for both conveyors
    setupLapListeners('conveyor1', lapTimes1);
    setupLapListeners('conveyor2', lapTimes2);

    // Get references to the settings button and the pop-up window
    const openSettingsButton = document.getElementById('openSettings');
    const closeSettingsButton = document.getElementById('closeSettings');
    const settingsPopup = document.getElementById('settingsPopup');

    // Function to open the settings pop-up
    if (openSettingsButton) {
        openSettingsButton.addEventListener('click', () => {
            settingsPopup.style.display = 'block';
        });
    } else {
        console.error('Open settings button element not found');
    }

    // Function to close the settings pop-up
    if (closeSettingsButton) {
        closeSettingsButton.addEventListener('click', () => {
            settingsPopup.style.display = 'none';
        });
    } else {
        console.error('Close settings button element not found');
    }

    // Event listeners for conveyor unit settings
    document.getElementById('conveyor1Units').addEventListener('change', (event) => {
        conveyor1Units = parseInt(event.target.value);
        displayStats();
    });

    document.getElementById('conveyor2Units').addEventListener('change', (event) => {
        conveyor2Units = parseInt(event.target.value);
        displayStats();
    });

    // Event listener for reset laps button
    document.getElementById('resetLaps').addEventListener('click', () => {
        const confirmation = window.confirm('Are you sure you want to reset the laps?');
        if (confirmation) {
            // Clear the lap times arrays
            lapTimes1.length = 0;
            lapTimes2.length = 0;
            displayStats();
        }
    });

    // Event listeners for average laps settings
    document.getElementById('conveyor1AvgLaps').addEventListener('change', (event) => {
        conveyor1AvgLaps = parseInt(event.target.value);
        displayStats();
    });

    document.getElementById('conveyor2AvgLaps').addEventListener('change', (event) => {
        conveyor2AvgLaps = parseInt(event.target.value);
        displayStats();
    });

    // Call the displayStats function if it's defined elsewhere in your code
    displayStats();

    // Auto pull 10 laps on page open and start conveyors
    const lapCount = 10;

    // Retrieve the specified number of laps from Firebase for Conveyor 1
    pullAndDisplay('conveyor1', lapTimes1, lapCount, () => {
        lapStart1 = Date.now();
        running1 = true;
        document.getElementById('startConveyor1').textContent = "STOP CONVEYOR 1";
        displayStats();
    });

    // Retrieve the specified number of laps from Firebase for Conveyor 2
    pullAndDisplay('conveyor2', lapTimes2, lapCount, () => {
        lapStart2 = Date.now();
        running2 = true;
        document.getElementById('startConveyor2').textContent = "STOP CONVEYOR 2";
        displayStats();
    });

    // Setup listeners for both conveyors
    setupLapListeners('conveyor1Boron', lapTimes1);
    setupLapListeners('conveyor2Boron', lapTimes2);

    // Watch Firebase for new laps and pull them
    watchForNewLaps('conveyor1', lapTimes1);
    watchForNewLaps('conveyor2', lapTimes2);
});

function pullAndDisplay(conveyor, lapTimesArray, count, callback) {
    // Adjust reference based on the conveyor name
    const lapsRef = database.ref(`laps/${conveyor}`).limitToLast(count);

    lapsRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            lapTimesArray.length = 0; // Clear the existing lap times

            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const entryData = data[key];
                    if (entryData) {
                        try {
                            const parsedData = JSON.parse(entryData.data); // Parse the stringified JSON
                            if (parsedData.lapTime && parsedData.timeOfDay) {
                                lapTimesArray.push(parsedData);
                                if (lapTimesArray.length > 10) {
                                    lapTimesArray.shift(); // Remove the oldest lap if more than 10 laps
                                }
                            } else {
                                console.error('Parsed data is missing lapTime or timeOfDay:', parsedData);
                            }
                        } catch (e) {
                            console.error('Failed to parse entry data:', entryData, e);
                        }
                    } else {
                        console.error('Entry data is undefined or null:', entryData);
                    }
                }
            }
            displayStats();
            if (callback) callback(); // Call the callback function if provided
        } else {
            console.error('No data found in snapshot.');
        }
    }).catch((error) => {
        console.error('Error pulling data from Firebase:', error);
    });
}

// Function to reset Irregulars to 0 and pull laps
function handleIrregularsChange(value) {
    if (value === 1) {
        // Reset Irregulars to 0
        database.ref('settings/Irregulars').set(0, (error) => {
            if (error) {
                console.error('Failed to reset Irregulars in Firebase:', error);
            } else {
                console.log('Irregulars reset to 0 in Firebase.');
            }
        });

        // Pull 8 laps as done on button click
        const lapCount = 9;
        pullAndDisplay('conveyor1', lapTimes1, lapCount, () => {
            lapStart1 = Date.now();
            running1 = true;
            document.getElementById('startConveyor1').textContent = "STOP CONVEYOR 1";
            displayStats();
        });

        pullAndDisplay('conveyor2', lapTimes2, lapCount, () => {
            lapStart2 = Date.now();
            running2 = true;
            document.getElementById('startConveyor2').textContent = "STOP CONVEYOR 2";
            displayStats();
        });
    }
}

// Listen for changes in the Irregulars value
database.ref('settings/Irregulars').on('value', (snapshot) => {
    const value = snapshot.val();
    handleIrregularsChange(value);
});

function setupLapListeners(conveyor, lapTimesArray) {
    let lastLapKey = null;

    // Listen to laps/conveyor1 and laps/conveyor2 paths
    const lapsRef = database.ref(`laps/${conveyor}`).limitToLast(1);

    lapsRef.once('value', (snapshot) => {
        const entries = Object.entries(snapshot.val() || {});
        if (entries.length > 0) {
            lastLapKey = entries[0][0]; // Store the key of the last lap
        }

        lapsRef.on('child_added', (childSnapshot) => {
            if (childSnapshot.key !== lastLapKey) {
                lastLapKey = childSnapshot.key; // Update the key of the last lap

                const rawData = childSnapshot.val();
                try {
                    const parsedData = JSON.parse(rawData.data);
                    handleNewLap(parsedData, lapTimesArray);
                } catch (e) {
                    console.error('Failed to parse raw data:', rawData, e);
                }
            }
        });
    }).catch((error) => {
        console.error('Error setting up lap listeners in Firebase:', error);
    });
}
// Set to store unique lap identifiers
const uniqueLapIdentifiers = new Set();
function handleNewLap(lapData, lapTimes) {
    try {
        if (lapData.lapTime && lapData.timeOfDay) {
            // Create a unique identifier for the lap
            const lapIdentifier = `${lapData.timeOfDay}-${lapData.lapTime}`;

            // Check if the lap already exists in the set
            if (!uniqueLapIdentifiers.has(lapIdentifier)) {
                // Add the lap identifier to the set
                uniqueLapIdentifiers.add(lapIdentifier);

                // Add the lap to the lapTimes array
                lapTimes.push(lapData);
                if (lapTimes.length > 10) {
                    // Remove the oldest lap if more than 10 laps
                    const removedLap = lapTimes.shift();
                    // Remove the identifier of the removed lap from the set
                    const removedLapIdentifier = `${removedLap.timeOfDay}-${removedLap.lapTime}`;
                    uniqueLapIdentifiers.delete(removedLapIdentifier);
                }
                checkLapLengths(lapTimes); // Check lap lengths when a new lap is added
                displayStats();
            } else {
                console.log('Duplicate lap detected:', lapData);
            }
        } else {
            console.error('Lap data is missing lapTime or timeOfDay:', lapData);
        }
    } catch (e) {
        console.error('Failed to handle new lap data:', lapData, e);
    }
}

// Convert date and time strings to timestamps and create an array of lap objects
function openDeleteLapPopup(conveyor) {
    const lapListDiv = document.getElementById('lapList');
    lapListDiv.innerHTML = ''; // Clear previous lap list

    // Get the lap times for the selected conveyor
    const lapTimes = conveyor === 'conveyor1' ? lapTimes1 : lapTimes2;

    // Convert date and time strings to timestamps and create an array of lap objects
    const lapObjects = lapTimes.map((lapData, index) => {
        const timestamp = lapData.timeOfDay ? Date.parse(lapData.timeOfDay.replace(/\//g, '/') + ':00') : 0;
        return { index, timestamp, lapData };
    });

    // Sort lap objects by timestamp in ascending order
    lapObjects.sort((a, b) => a.timestamp - b.timestamp);

    // Reverse the order to have the newest lap at the top
    lapObjects.reverse();

    // Display the list of laps with delete buttons
    lapObjects.forEach((lapObj) => {
        const lapData = lapObj.lapData;
        const lapTimeStr = lapData.lapTime;
        lapListDiv.innerHTML += `
            <div>
                <button onclick="deleteSelectedLap('${conveyor}', ${lapObj.index})">
                    Delete Lap (${lapData.timeOfDay}) - ${lapTimeStr}
                </button>
            </div>
        `;
    });

    // Show the lap selection pop-up
    const deleteLapPopup = document.getElementById('deleteLapPopup');
    deleteLapPopup.style.display = 'block';
}

function parseTime(timeStr) {
    if (typeof timeStr !== 'string') {
        console.error('Invalid timeStr:', timeStr);
        return 0;
    }
    const timeParts = timeStr.split(':').map(Number);
    if (timeParts.length !== 3 || timeParts.some(isNaN)) {
        console.error('Invalid time components:', timeStr);
        return 0;
    }
    const [hours, minutes, seconds] = timeParts;
    return hours * 3600 + minutes * 60 + seconds;
}

function checkLapLengths(lapTimes) {
    const lapDurations = lapTimes.map(lap => parseTime(lap.lapTime));
    const averageLapDuration = lapDurations.reduce((a, b) => a + b, 0) / lapDurations.length;

    for (let i = lapTimes.length - 1; i >= 0; i--) {
        const lapDuration = parseTime(lapTimes[i].lapTime);
        if (lapDuration > 2 * averageLapDuration) {
            lapTimes.splice(i, 1); // Remove the lap if it is red
        } else {
            lapTimes[i].color = 'purple'; // Mark the lap as purple
        }
    }
}

function watchForNewLaps(conveyor, lapTimesArray) {
    const lapsRef = database.ref(`laps/${conveyor}`).limitToLast(1);

    lapsRef.once('value', (snapshot) => {
        const entries = Object.entries(snapshot.val() || {});
        if (entries.length > 0) {
            lastLapKey = entries[0][0]; // Store the key of the last lap
        }

        lapsRef.on('child_added', (childSnapshot) => {
            if (childSnapshot.key !== lastLapKey) {
                lastLapKey = childSnapshot.key; // Update the key of the last lap

                const rawData = childSnapshot.val();
                try {
                    const parsedData = JSON.parse(rawData.data);
                    handleNewLap(parsedData, lapTimesArray);
                } catch (e) {
                    console.error('Failed to parse raw data:', rawData, e);
                }
            }
        });
    }).catch((error) => {
        console.error('Error setting up lap listeners in Firebase:', error);
    });
}

function pullLapsFromFirebase(conveyor, lapTimesArray, lapCount) {
    const lapsRef = database.ref(`laps/${conveyor}`).limitToLast(lapCount);

    lapsRef.once('value', (snapshot) => {
        const entries = Object.entries(snapshot.val() || {});
        entries.forEach(([key, rawData]) => {
            try {
                const parsedData = JSON.parse(rawData.data);
                handleNewLap(parsedData, lapTimesArray);
            } catch (e) {
                console.error('Failed to parse raw data:', rawData, e);
            }
        });
    }).catch((error) => {
        console.error('Error pulling laps from Firebase:', error);
    });
}
  // Simulate a click on the "Pull Laps" button 1 seconds after page load
  setTimeout(simulatePullLapsButtonClick, 1000);
</script>
</body>
</html>
