<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   
    
    <link rel="apple-touch-icon" href="icon.png">
    <title>Conveyor Calculator</title>
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <!-- Shortcut Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .popup-content {
    background-image: url('back2.jpg');
    background-size: cover;
    background-repeat: no-repeat; 
    background-position: bottom right;  /* Adjust this line */
    max-height: 400px; /* You can adjust this value as per your requirement */
    overflow-y: auto;
}

.lap-time {
    background-color: rgba(0, 0, 0, 0.242); 
}

.popup-item {
    font-size: 20px;
    padding: 8px; /* Adjust the padding size as needed */
}
#deleteLapPopup button {
    font-size: 17px;  /* Adjust as per your need */
    padding: 7px 12px; /* Vertical and horizontal padding */
    cursor: pointer; /* To change cursor to hand when hovering */
    border: 1px solid black;
    border-radius: 5px;
    margin-top: 5px;
}


        body {
            background-color: black;
        }
        body {
            background-image: url('background.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-weight: bold;
        }
         .bold { font-weight: bold; }
        .input-small { width: 6rem; }
        .red { color: red; }
        .green { color: green; }
        .blue { color: blue; }
         .purple { color: purple; }
        .orange { color: orange; }
        .content {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
        }
        
        
.lap-time {
    background-color: rgba(0, 0, 0, 0.242); 
}
/* Add padding to the pop-up items */
.popup-item {
    font-size: 20px;
    padding: 10px; /* Adjust the padding size as needed */
}
        #recordLap1, #recordLap2 {
            width: auto;
            height: auto;
            font-size: 230%;
        }
    

        /* Increase the size of Conveyor headers by 50% */
        .conveyor-header {
        font-size: 180%;
        }

/* Style for the pop-up window */
.popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.242);
    z-index: 1;
}
button {
    color: rgb(0, 0, 0);
    background-color: white;
}

#countdownDisplay {
       
        bottom: 0;         /* Positions it at the bottom of the viewport */
        left: 0;           /* Aligns it to the left side */
        width: 100%;       /* Makes it span the full width of the viewport */
       
        color: rgb(255, 0, 0);      /* White text color for visibility */
        text-align: left; /* Center-aligns the text */
        padding: 10px 0;   /* Adds some vertical padding */
    }
   
    #conveyorCalculator {
   
    top: 0;                /* Positions it at the top of the viewport */
    left: 0;               /* Start from the very left edge of the viewport */
    width: 100%;           /* Makes it span the full width of the viewport */
    text-align: center;    /* Center-aligns the text */
   
    color: rgb(0, 0, 0);       /* White text color for visibility */
    padding: 10px 0;       /* Adds some vertical padding */
    box-sizing: border-box;/* Ensures that padding and border are included in the total width and height */
    z-index: 1000;         /* Ensures it stays above other elements */
}



.popup-content {
    background-color: white;
    width: 80%;
    max-width: 400px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
}

/* Style for the close button */
#closeSettings {
    background-color: #ccc;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    float: right;
}

/* Add more styles as needed for your settings window */

    </style>
</head><div class="content">
    <h1 id="conveyorCalculator" style="font-size: 2.2rem;">Conveyor Calculator</h1>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button id="startConveyor2" style="border: 1px solid black; border-radius: 5px; display: none; width: 0px; margin-top: 0px; margin-right: 0px;">START CONVEYOR 2</button>
        <button id="startConveyor1" style="border: 1px solid black; border-radius: 5px; display: none; width: 0px; margin-top: 0px; margin-left: 0px;">START CONVEYOR 1</button>
        
    </div>
    <div style="display: flex; justify-content: center; margin-top: 20px;">
        <button id="recordLap2" style="border: 1px solid black; border-radius: 5px;display: none; width: 170px; margin-right: 5px; font-size: 0px;">Lap Conveyor 2</button>
        <button id="recordLap1" style="border: 1px solid black; border-radius: 5px;display: none; width: 170px; margin-left: 5px; font-size: 0px;">Lap Conveyor 1</button>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; margin-top: 0px;">
        <div style="display: flex; justify-content: start; width: 100%;">
            <button id="openSettings" style="border: 1px solid black; border-radius: 5px; margin-right: auto; margin-top: 0px;">Settings</button>
            <button id="pullLaps" style="border: 1px solid black; border-radius: 5px; margin-left: auto; margin-top: 0px;">Pull Laps</button>
        </div>              
       
    </div>
    
    <div id="settingsPopup" class="popup">
        <div class="popup-content">
            <!-- Add content for the settings window here -->
            <button onclick="openDeleteLapPopup('conveyor2')" style="border: 1px solid black; border-radius: 5px;">Delete Lap Conveyor 2</button>
            <button onclick="openDeleteLapPopup('conveyor1')" style="border: 1px solid black; border-radius: 5px;">Delete Lap Conveyor 1</button>
            <div id="deleteLapPopup" class="popup">
                <div class="popup-content2">
                    <h2></h2>
                    <div id="lapList"></div>
                    <button onclick="closeDeleteLapPopup()" style="border: 1px solid black; border-radius: 5px;">Cancel</button>
                </div>
            </div>

            <div class="black" style="margin-top: 40px;">
                Subtract Cut conveyor1 =
                <input type="number" id="subtractLoad1" class="input-small" style="border: 1px solid black; border-radius: 5px;" placeholder="Subtract Load 1">
            </div>
            <div class="black" style="margin-top: 10px;">
                Subtract Cut conveyor2 =
                <input type="number" id="subtractLoad2" class="input-small" style="border: 1px solid black; border-radius: 5px;" placeholder="Subtract Load 2">
            </div>

           

           
       
        </div>
        <button id="closeSettings" style="border: 1px solid black; border-radius: 10px; background-color: white; color: black; padding: 10px 20px; font-size: 16px; position: absolute; margin-top: 20px; left: 50%; transform: translate(-50%, -50%);">Done</button>
    </div>
    <div class="black" style="margin-top: 10px;">
        Set AM-PM  
        <input type="time" id="timeInput" class="input-small" style="border: 1px solid black;margin-top: 10px;color: black; background-color: white;border-radius: 5px; margin-right: 0px; padding: 0;" value="05:15">
    <button id="setTime" style="border: 1px solid black; display: none; border-radius: 5px; margin-left: 2px;margin-top: 10px; padding: 6;">Set</button>            
    </div>
</div>
<div id="stats" class="content">
    <!-- Display statistics here -->
</div>

<div id="clock" class="countdown-timer"></div>




    <script src="https://www.gstatic.com/firebasejs/9.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.5.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdX_RAPVeG-uekG-lG1nhSFzZkTMRgg0c",
            authDomain: "conveyor-laps.firebaseapp.com",
            databaseURL: "https://conveyor-laps-default-rtdb.firebaseio.com",
            projectId: "conveyor-laps",
            storageBucket: "conveyor-laps.appspot.com",
            messagingSenderId: "708197721355",
            appId: "1:708197721355:web:234d1d9223b125a657ee0e",
            measurementId: "G-X2REH4L1M5"
        };

// Initialize Firebase initially
firebase.initializeApp(firebaseConfig);
let database = firebase.database();

let isOnline = true; // Track online/offline status

// Function to send data to Firebase
function sendDataToFirebase(data) {
    // Check if the device is online
    if (isOnline) {
        // Attempt to send the data to Firebase
        database.ref('your_data_path').push(data, (error) => {
            if (error) {
                // Data transmission failed, implement retry mechanism here
                retrySendingData(data);
            } else {
                // Data sent successfully
                console.log('Data sent to Firebase.');
            }
        });
    } else {
        // Device is offline, implement retry mechanism here
        retrySendingData(data);
    }
}

// Retry mechanism
let retryCount = 0;
const maxRetries = 5; // Maximum number of retry attempts

function retrySendingData(data) {
    if (retryCount < maxRetries) {
        retryCount++;
        console.log(`Retry attempt ${retryCount} to send data.`);
        
        // Implement a delay before retrying (e.g., 5 seconds)
        setTimeout(() => {
            sendDataToFirebase(data); // Retry sending data
        }, 5000); // 5000 milliseconds (5 seconds)
    } else {
        console.log('Max retry attempts reached. Data transmission failed.');
    }
}

// Function to reinitialize Firebase
function reinitializeFirebase() {
    // Close the current app instance
    firebase.app().delete().then(() => {
        // Re-initialize Firebase
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log("Firebase reinitialized!");
    }).catch((error) => {
        console.error("Error reinitializing Firebase:", error);
    });
}

// Set an interval to reinitialize Firebase every 30 minutes
setInterval(reinitializeFirebase, 30 * 60 * 1000);


// Listen for online/offline events
window.addEventListener('online', () => {
    isOnline = true;
    console.log('Device is online.');

    // Check if there is pending data to send, and if so, trigger data transmission
    if (pendingDataToSend.length > 0) {
        console.log('Sending pending data...');
        for (const data of pendingDataToSend) {
            sendDataToFirebase(data);
        }
        pendingDataToSend = []; // Clear the pending data array
    }
});

window.addEventListener('offline', () => {
    isOnline = false;
    console.log('Device is offline.');
});

// Call sendDataToFirebase when you want to send data
const dataToSend = { /* your data object */ };
sendDataToFirebase(dataToSend);


        let lapStart1 = 0;
        let lapStart2 = 0;
        let running1 = false;
        let running2 = false;
        const lapTimes1 = [];
        const lapTimes2 = [];
        let timeDifference = 0;
        let timeDifferenceRemaining = 0;
        let workToBeDone1 = 0;
        let workToBeDone2 = 0;
        let targetTime = 0;
        let countdownInterval;
        let loadValue1 = 0;
        let loadValue2 = 0;

   

       // Function to open the lap selection pop-up for a specific conveyor
function openDeleteLapPopup(conveyor) {
    const lapListDiv = document.getElementById('lapList');
    lapListDiv.innerHTML = ''; // Clear previous lap list

    // Get the lap times for the selected conveyor
    const lapTimes = conveyor === 'conveyor1' ? lapTimes1 : lapTimes2;

    // Convert date and time strings to timestamps and create an array of lap objects
    const lapObjects = lapTimes.map((lapData, index) => {
        const timestamp = Date.parse(lapData[1].replace(/\//g, '/') + ':00');
        return { index, timestamp, lapData };
    });

    // Sort lap objects by timestamp in ascending order
    lapObjects.sort((a, b) => a.timestamp - b.timestamp);

    // Reverse the order to have the newest lap at the top
    lapObjects.reverse();

    // Display the list of laps with delete buttons
    lapObjects.forEach((lapObj) => {
        const lapData = lapObj.lapData;
        const lapTimeStr = formatTime(Math.floor(lapData[0] / 1000));
        lapListDiv.innerHTML += `
            <div>
                <button onclick="deleteSelectedLap('${conveyor}', ${lapObj.index})">
                    Delete Lap (${lapData[1]}) - ${lapTimeStr}
                </button>
            </div>
        `;
    });

    // Show the lap selection pop-up
    const deleteLapPopup = document.getElementById('deleteLapPopup');
    deleteLapPopup.style.display = 'block';
}


    // Function to close the lap selection pop-up
    function closeDeleteLapPopup() {
        const deleteLapPopup = document.getElementById('deleteLapPopup');
        deleteLapPopup.style.display = 'none';
    }

    // Function to delete a selected lap for a specific conveyor
    function deleteSelectedLap(conveyor, index) {
        const lapTimes = conveyor === 'conveyor1' ? lapTimes1 : lapTimes2;

        if (index >= 0 && index < lapTimes.length) {
            lapTimes.splice(index, 1); // Remove the selected lap
            displayStats(); // Update statistics
        }

        closeDeleteLapPopup(); // Close the lap selection pop-up
    }

    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secondsStr = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondsStr.toString().padStart(2, '0')}`;
    }

     // Function to subtract load value from Conveyor 1
document.getElementById('subtractLoad1').addEventListener('input', () => {
    const subtractLoad1 = parseInt(document.getElementById('subtractLoad1').value);
    if (!isNaN(subtractLoad1)) {
        // Subtract the entered value from the initial loadValue1
        loadValue1 = 0 - subtractLoad1;
        displayStats();
    } else {
        // If the input box is empty or contains non-numeric characters, reset the load value to 0
        loadValue1 = 0;
        displayStats();
    }
});

document.getElementById('subtractLoad2').addEventListener('input', () => {
    const subtractLoad2 = parseInt(document.getElementById('subtractLoad2').value);
    if (!isNaN(subtractLoad2)) {
        // Subtract the entered value from the initial loadValue2
        loadValue2 = 0 - subtractLoad2;
        displayStats();
    } else {
        // If the input box is empty or contains non-numeric characters, reset the load value to 0
        loadValue2 = 0;
        displayStats();
    }
});

        function calculateWorkToBeDone(averageTime, timeDifference) {
            return (averageTime > 0 ? timeDifference / averageTime : 0) - loadValue1 - loadValue2;
        }
        function displayStats() {
    const statsDiv = document.getElementById('stats');
    statsDiv.innerHTML = '';

    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secondsStr = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondsStr.toString().padStart(2, '0')}`;
    }
   
    statsDiv.innerHTML += '<div class="red conveyor-header">Conveyor 1:</div>';

const averageTime1 = calculateAverageTime(lapTimes1);
statsDiv.innerHTML += `<div class="green">Average Lap Time: ${formatTime(averageTime1)}</div>`;
statsDiv.innerHTML += `<div class="black" style="display: none;">Average Last 4 Laps: ${formatTime(calculateAverageTimeX4(lapTimes1))}</div>`;
statsDiv.innerHTML += `<div class="green" style="display: none;">Average Last 2 Laps: ${formatTime(calculateAverageTimeX2(lapTimes1))}</div>`;

if (running1) {
    const runningTime1 = Math.floor((Date.now() - lapStart1) / 1000);
    statsDiv.innerHTML += '<div class="black bold">Conveyor 1 is running</div>';
    statsDiv.innerHTML += `<div class="blue bold">Current lap time: ${formatTime(runningTime1)}</div>`;
} else {
    statsDiv.innerHTML += '<div class="black">Conveyor 1 stopped</div>';
}


statsDiv.innerHTML += '<div class="blue" style="display: none;>Lap times:</div>';
lapTimes1.slice().reverse().forEach((lapData, idx) => {
    const lapTimeStr = formatTime(Math.floor(lapData[0] / 1000));
    statsDiv.innerHTML += `<div class="purple">${lapTimes1.length - idx}.(${lapData[1]}) - ${lapTimeStr} </div>`;
});



    // Display load lift information at all times
    const averageTimeAll1 = calculateAverageTime(lapTimes1);
            const averageTimeX2_1 = calculateAverageTimeX2(lapTimes1);
            const averageTimeX4_1 = calculateAverageTimeX4(lapTimes1);

            const workToBeDone1_All = calculateWorkToBeDone(averageTimeAll1, timeDifferenceRemaining);
            const workToBeDone1_X2 = calculateWorkToBeDone(averageTimeX2_1, timeDifferenceRemaining);
            const workToBeDone1_X4 = calculateWorkToBeDone(averageTimeX4_1, timeDifferenceRemaining);

            statsDiv.innerHTML += `<div class="black" style="font-size: 118%;">Load Conveyor = ${(workToBeDone1_All + loadValue1).toFixed(1)} <span style="margin-left: 40px;">Lifts = ${((workToBeDone1_All + loadValue1) * 10 / 16).toFixed(1)}</span></div>`;
            statsDiv.innerHTML += `<div class="black" style="display: none;>Avg 4x - Load Conveyor 1 = ${(workToBeDone1_X4 + loadValue1).toFixed(1)}  (Lifts = ${((workToBeDone1_X4 + loadValue1) * 10 / 16).toFixed(1)})</div>`;
            statsDiv.innerHTML += `<div class="green" style="display: none;>Avg 2x - Load Conveyor 1 = ${(workToBeDone1_X2 + loadValue1).toFixed(1)}  (Lifts = ${((workToBeDone1_X2 + loadValue1) * 10 / 16).toFixed(1)})</div>`;


            statsDiv.innerHTML += '<div class="red conveyor-header">Conveyor 2:</div>';

const averageTime2 = calculateAverageTime(lapTimes2);
statsDiv.innerHTML += `<div class="green">Average Lap Time : ${formatTime(averageTime2)}</div>`;
statsDiv.innerHTML += `<div class="black" style="display: none;">Average Last 4 Laps: ${formatTime(calculateAverageTimeX4(lapTimes2))}</div>`;
statsDiv.innerHTML += `<div class="green" style="display: none;">Average Last 2 Laps: ${formatTime(calculateAverageTimeX2(lapTimes2))}</div>`;

if (running2) {
    const runningTime2 = Math.floor((Date.now() - lapStart2) / 1000);
    statsDiv.innerHTML += '<div class="black bold">Conveyor 2 is running</div>';
    statsDiv.innerHTML += `<div class="blue bold">Current lap time: ${formatTime(runningTime2)}</div>`;
} else {
    statsDiv.innerHTML += '<div class="black">Conveyor 2 stopped</div>';
}

statsDiv.innerHTML += '<div class="blue" style="display: none;>Lap times:</div>';
lapTimes2.slice().reverse().forEach((lapData, idx) => {
    const lapTimeStr = formatTime(Math.floor(lapData[0] / 1000));
    statsDiv.innerHTML += `<div class="purple">${lapTimes2.length - idx}.(${lapData[1]}) - ${lapTimeStr} </div>`;
});




    // Display load lift information at all times
    const averageTimeAll2 = calculateAverageTime(lapTimes2);  // Use lapTimes2
const averageTimeX2_2 = calculateAverageTimeX2(lapTimes2); // Use lapTimes2
const averageTimeX4_2 = calculateAverageTimeX4(lapTimes2); // Use lapTimes2

const workToBeDone2_All = calculateWorkToBeDone(averageTimeAll2, timeDifferenceRemaining);
const workToBeDone2_X2 = calculateWorkToBeDone(averageTimeX2_2, timeDifferenceRemaining);
const workToBeDone2_X4 = calculateWorkToBeDone(averageTimeX4_2, timeDifferenceRemaining);

statsDiv.innerHTML += `<div class="black" style="font-size: 118%;">Load Conveyor = ${(workToBeDone2_All + loadValue2).toFixed(1)} <span style="margin-left: 40px;">Lifts = ${((workToBeDone2_All + loadValue2) * 10 / 16).toFixed(1)}</span></div>`;
statsDiv.innerHTML += `<div class="black" style="display: none;">Avg 4x - Load Conveyor 2 = ${(workToBeDone2_X4 + loadValue2).toFixed(1)}  (Lifts = ${((workToBeDone2_X4 + loadValue2) * 10 / 16).toFixed(1)})</div>`;
statsDiv.innerHTML += `<div class="green" style="display: none;">Avg 2x - Load Conveyor 2 = ${(workToBeDone2_X2 + loadValue2).toFixed(1)}  (Lifts = ${((workToBeDone2_X2 + loadValue2) * 10 / 16).toFixed(1)})</div>`;


    if (timeDifferenceRemaining > 0) {
        statsDiv.innerHTML += `<div id="countdownDisplay" class="red bold">Time to Shift Change: ${formatTime(timeDifferenceRemaining)}</div>`;
    }
}
        function startCountdown() {
            clearInterval(countdownInterval);
            countdownInterval = setInterval(function() {
                if (timeDifferenceRemaining > 0) {
                    timeDifferenceRemaining--;
                    displayStats();
                }
            }, 1000);
        }

        function calculateWorkToBeDone(averageTime, timeDifference) {
            return averageTime > 0 ? timeDifference / averageTime : 0;
        }

        function getFormattedTime() {
            const now = new Date();
            const day = now.getDate();
            const month = now.getMonth() + 1; // Months are 0-based, so add 1
            const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}`;
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            const formattedTime = `${formattedDate} ${hours % 12}:${(minutes < 10 ? '0' : '') + minutes} ${ampm}`;
            return formattedTime;
        }

        function calculateAverageTime(lapTimes) {
            const totalLapTime = lapTimes.reduce((total, lapData) => total + lapData[0], 0);
            const numLaps = lapTimes.length;
            return numLaps > 0 ? totalLapTime / numLaps / 1000 : 0;
        }

        function calculateAverageTimeX2(lapTimes) {
            const lastTwoLaps = lapTimes.slice(-2);
            const totalLapTime = lastTwoLaps.reduce((total, lapData) => total + lapData[0], 0);
            return lastTwoLaps.length > 0 ? totalLapTime / lastTwoLaps.length / 1000 : 0;
        }

        function calculateAverageTimeX4(lapTimes) {
            const lastFourLaps = lapTimes.slice(-4);
            const totalLapTime = lastFourLaps.reduce((total, lapData) => total + lapData[0], 0);
            return lastFourLaps.length > 0 ? totalLapTime / lastFourLaps.length / 1000 : 0;
        }



        function sendLapDataToFirebase(conveyor, lapTime, timeOfDay) {
            // Check if the lap time is greater than 15 minutes (900,000 milliseconds)
            if (lapTime > 900000) {
                // Send lap time data to Firebase
                database.ref(`laps/${conveyor}`).push({
                    lapTime: lapTime,
                    timeOfDay: timeOfDay
                });
            }
        }

        document.getElementById('recordLap1').addEventListener('click', () => {
            if (running1) {
                const lapTime = Date.now() - lapStart1;
                const timeOfDay = getFormattedTime();
                lapTimes1.push([lapTime, timeOfDay]);
                lapStart1 = Date.now();
                displayStats();

                // Send lap time data to Firebase
                sendLapDataToFirebase('conveyor1', lapTime, timeOfDay);
            }
        });

        document.getElementById('recordLap2').addEventListener('click', () => {
            if (running2) {
                const lapTime = Date.now() - lapStart2;
                const timeOfDay = getFormattedTime();
                lapTimes2.push([lapTime, timeOfDay]);
                lapStart2 = Date.now();
                displayStats();

                // Send lap time data to Firebase
                sendLapDataToFirebase('conveyor2', lapTime, timeOfDay);
            }
        });

        document.getElementById('setTime').addEventListener('click', () => {
            const timeInput = document.getElementById('timeInput').value;
            const timeParts = timeInput.split(':');
            if (timeParts.length === 2) {
                const hours = parseInt(timeParts[0]);
                const minutes = parseInt(timeParts[1]);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    const now = new Date();
                    targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                    if (targetTime <= now) {
                        targetTime.setDate(targetTime.getDate() + 1);
                    }
                    timeDifference = targetTime.getTime() - now.getTime();
                    timeDifferenceRemaining = timeDifference / 1000;
                    workToBeDone1 = calculateWorkToBeDone(calculateAverageTime(lapTimes1), timeDifferenceRemaining);
                    workToBeDone2 = calculateWorkToBeDone(calculateAverageTime(lapTimes2), timeDifferenceRemaining);
                    displayStats();
                    startCountdown();
                }
            }
        });
     
   document.getElementById('pullLaps').addEventListener('click', () => {
    const lapCountInput = prompt("Enter the number of laps to pull:", "6");

    if (lapCountInput !== null) {
        const lapCount = parseInt(lapCountInput);

        if (!isNaN(lapCount) && lapCount > 0) {
            retrieveAndTransformData('conveyor1Boron', lapTimes1, lapCount);
            retrieveAndTransformData('conveyor2Boron', lapTimes2, lapCount);
        } else {
            alert("Please enter a valid number of laps greater than 0.");
        }
    }
});

function retrieveAndTransformData(conveyorRef, lapTimes, lapCount) {
    const lapsRef = database.ref(`laps/${conveyorRef}`).limitToLast(lapCount);
    lapsRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            lapTimes.length = 0; // Clear the existing lap times

            for (const key in data) {
                const rawData = data[key];

                // Transform Particle console's data into desired structure
                const transformedData = JSON.parse(rawData.data);

                lapTimes.push([transformedData.lapTime, transformedData.timeOfDay]);
            }

            displayStats();
        }
    });
}

function handleNewLap(lapData, lapTimes) {
    const newLap = [lapData.lapTime, lapData.timeOfDay];
    lapTimes.push(newLap);
    displayStats();
}

function setupParticleListeners(conveyorRef, lapTimes) {
    let lastLapKey = null;

    const lapsRef = database.ref(`laps/${conveyorRef}`).limitToLast(1);
    lapsRef.once('value', (snapshot) => {
        const entries = Object.entries(snapshot.val() || {});
        if (entries.length > 0) {
            lastLapKey = entries[0][0];  // Store the key of the last lap
        }

        lapsRef.on('child_added', (childSnapshot) => {
            if (childSnapshot.key !== lastLapKey) {
                lastLapKey = childSnapshot.key;  // Update the key of the last lap

                // Transform Particle console's data and add it
                const rawData = childSnapshot.val();
                const transformedData = JSON.parse(rawData.data);
                handleNewLap(transformedData, lapTimes);
            }
        });
    });
}

// Assuming you've defined lapTimes1 and lapTimes2 elsewhere
let lapTimes1 = [];
let lapTimes2 = [];

// Setting up the listeners for the Particle data
setupParticleListeners('conveyor1Boron', lapTimes1);
setupParticleListeners('conveyor2Boron', lapTimes2);

        // Function to simulate a click on the "Set Time" button
        function simulateSetTimeButtonClick() {
            const setTimeButton = document.getElementById('setTime');
            setTimeButton.click();
        }
        // Automatically click the "Set Time" button every 1 second
        setInterval(simulateSetTimeButtonClick, 1000);
        
        // New function to ping Firebase
        function pingFirebase() {
            const ref = database.ref('.info/connected');
            ref.on('value', (snap) => {
                if (snap.val() === true) {
                    console.log('Connected to Firebase');
                } else {
                    console.log('Disconnected from Firebase');
                }
            });
        }
        // Ping Firebase every 2.5 minutes (250,000 milliseconds)
        setInterval(pingFirebase, 250000);

        function confirmDeleteLap(conveyor, index) {
    // Show a confirmation dialog
    const confirmation = window.confirm (` ${index + 1}  ${conveyor === 'conveyor1 ' ? '1' : '2'} `);
    if (confirmation) {
        deleteLap(conveyor, index);
    }
}
    document.addEventListener('DOMContentLoaded', () => {
    // Your existing code here

    // Get references to the settings button and the pop-up window
    const openSettingsButton = document.getElementById('openSettings');
    const closeSettingsButton = document.getElementById('closeSettings');
    const settingsPopup = document.getElementById('settingsPopup');

    // Function to open the settings pop-up
    openSettingsButton.addEventListener('click', () => {
        settingsPopup.style.display = 'block';
    });

    // Function to close the settings pop-up
    closeSettingsButton.addEventListener('click', () => {
        settingsPopup.style.display = 'none';
    });

    // Continue with the rest of your code...
    // ...

    // Call the displayStats function if it's defined elsewhere in your code
    displayStats();

 // Automated function to stop Conveyor 1
function stopConveyor1() {
    const button = document.getElementById('startConveyor1');
    running1 = false;
    button.textContent = "START CONVEYOR 1";
    if (timeDifferenceRemaining > 0) {
        workToBeDone1 = calculateWorkToBeDone(calculateAverageTime(lapTimes1), timeDifferenceRemaining);
        displayStats();
    }
}

// Automated function to stop Conveyor 2
function stopConveyor2() {
    const button = document.getElementById('startConveyor2');
    running2 = false;
    button.textContent = "START CONVEYOR 2";
    if (timeDifferenceRemaining > 0) {
        workToBeDone2 = calculateWorkToBeDone(calculateAverageTime(lapTimes2), timeDifferenceRemaining);
        displayStats();
    }
}

// Automated function to start Conveyor 1
function startConveyor1() {
    const button = document.getElementById('startConveyor1');
    lapStart1 = Date.now();
    running1 = true;
    button.textContent = "STOP CONVEYOR 1";
    startCountdown();
    displayStats();
}

// Automated function to start Conveyor 2
function startConveyor2() {
    const button = document.getElementById('startConveyor2');
    lapStart2 = Date.now();
    running2 = true;
    button.textContent = "STOP CONVEYOR 2";
    startCountdown();
    displayStats();
}

// Inside your child_added listener for Conveyor 1:
lapsRef1.on('child_added', (childSnapshot) => {
    if (childSnapshot.key !== lastLapKey1) {
        lastLapKey1 = childSnapshot.key;
        handleNewLap(childSnapshot.val(), lapTimes1);
        stopConveyor1(); // Stop Conveyor 1
        startConveyor1(); // Start Conveyor 1
    }
});

// Similarly for Conveyor 2:
lapsRef2.on('child_added', (childSnapshot) => {
    if (childSnapshot.key !== lastLapKey2) {
        lastLapKey2 = childSnapshot.key;
        handleNewLap(childSnapshot.val(), lapTimes2);
        stopConveyor2(); // Stop Conveyor 2
        startConveyor2(); // Start Conveyor 2
    }
});


});    
    </script>
</body>
</html>
